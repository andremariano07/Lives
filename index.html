<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel de Lives</title>

<!-- Leaflet (Mapa) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:#00bfff;
    --text:#fff;
    --muted:#bbb;
    --border:#222;
    --radius:12px;
  }

  body { margin:0; background:var(--bg); font-family:Arial, sans-serif; color:var(--text); }

  #topbar{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 14px; border-bottom:1px solid var(--border); gap:12px;
  }
  #leftTop { display:flex; align-items:center; gap:10px; min-width:0; flex-wrap:wrap; }
  #status { color:var(--muted); font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 55vw; }
  #clock{ color:var(--accent); font-size:22px; font-weight:bold; white-space:nowrap; }

  .btn{
    background:var(--accent);
    color:#000;
    border:none;
    border-radius:10px;
    padding:7px 10px;
    font-weight:800;
    cursor:pointer;
    white-space:nowrap;
  }
  .btn.secondary{
    background:#1f1f1f;
    color:var(--text);
    border:1px solid #2b2b2b;
    font-weight:700;
  }

  /* Tabs */
  .tabBtn.active{
    background: var(--accent);
    color:#000;
    border-color: transparent;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    padding:12px;
    height: calc(100vh - 58px);
    box-sizing:border-box;
  }

  .panel{
    border:2px solid var(--accent);
    border-radius:var(--radius);
    overflow:hidden;
    background:var(--panel);
    display:flex;
    flex-direction:column;
    min-height: 0;
  }

  .title{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    background:var(--accent);
    color:#000;
    font-weight:bold;
    padding:8px 10px;
  }

  .title .name{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    flex:1;
  }

  .titleRight{
    display:flex;
    align-items:center;
    gap:8px;
    flex-shrink:0;
  }

  .pill{
    background: rgba(0,0,0,0.25);
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    white-space:nowrap;
    min-width: 90px;
    text-align:center;
  }

  .miniBtn{
    background: rgba(0,0,0,0.35);
    border:1px solid rgba(0,0,0,0.20);
    color:#fff;
    padding:6px 10px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    white-space:nowrap;
  }

  /* üî¥ AO VIVO badge */
  .liveBadge{
    display:none;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background: rgba(0,0,0,0.30);
    color:#fff;
    font-weight:900;
    white-space:nowrap;
    border:1px solid rgba(0,0,0,0.20);
  }
  .liveBadge .dot{
    width:10px; height:10px;
    border-radius:50%;
    background:#ff2b2b;
    box-shadow: 0 0 0 0 rgba(255,43,43,0.7);
    animation: pulse 1.2s infinite;
  }
  @keyframes pulse{
    0% { box-shadow: 0 0 0 0 rgba(255,43,43,0.65); }
    70% { box-shadow: 0 0 0 10px rgba(255,43,43,0.0); }
    100% { box-shadow: 0 0 0 0 rgba(255,43,43,0.0); }
  }

  .content{
    display:grid;
    grid-template-columns: 2fr 1fr;
    flex:1;
    min-height:0;
  }

  iframe{ width:100%; height:100%; border:0; }

  .chat-hidden .content{ grid-template-columns: 1fr; }
  .chat-hidden iframe.chat{ display:none; }

  /* ===== Modal ===== */
  .modalOverlay{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.65);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:9999;
  }
  .modal{
    width:min(720px, 100%);
    background:#0b0b0b;
    border:1px solid #2a2a2a;
    border-radius:18px;
    box-shadow: 0 16px 50px rgba(0,0,0,0.6);
    overflow:hidden;
  }
  .modalHeader{
    padding:14px 16px;
    background: #0f0f0f;
    border-bottom:1px solid #222;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .modalHeader h2{ margin:0; font-size:16px; color:#fff; }
  .modalBody{ padding:16px; display:grid; gap:12px; }
  .field label{ display:block; font-size:13px; color:#cfcfcf; margin-bottom:6px; }
  .field input{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #2a2a2a;
    background:#141414;
    color:#fff;
    box-sizing:border-box;
    outline:none;
  }
  .hint{ color:#9c9c9c; font-size:12px; line-height:1.35; }
  .modalFooter{
    padding:14px 16px;
    border-top:1px solid #222;
    display:flex;
    justify-content:flex-end;
    gap:10px;
  }

  /* üì∫ TV MODE */
  body.tv #topbar{ padding:8px 10px; }
  body.tv #status{ display:none; }
  body.tv .grid{
    padding:8px;
    gap:8px;
    height: calc(100vh - 52px);
  }
  body.tv .title{ padding:10px 12px; font-size:15px; }
  body.tv .pill, body.tv .miniBtn, body.tv .liveBadge{ padding:8px 12px; font-size:14px; }

  /* ===== MAPA: marcador piscando + label permanente ===== */
  .blinkDot{
    width:18px;
    height:18px;
    border-radius:50%;
    background:#00ff88;
    border:3px solid #002b18;
    box-shadow:0 0 0 0 rgba(0,255,136,.7);
    animation:pulseBlink 1.2s infinite;
  }
  @keyframes pulseBlink{
    0%{box-shadow:0 0 0 0 rgba(0,255,136,.6); transform:scale(1)}
    70%{box-shadow:0 0 0 18px rgba(0,255,136,0); transform:scale(1.08)}
    100%{box-shadow:0 0 0 0 rgba(0,255,136,0); transform:scale(1)}
  }

  .leaflet-tooltip.permaLabel{
    background: rgba(0,0,0,0.75);
    border:1px solid var(--accent);
    color:#fff;
    font-weight:800;
    padding:4px 8px;
    border-radius:8px;
    box-shadow:0 0 8px rgba(0,191,255,.35);
  }

  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; height:auto; min-height: calc(100vh - 58px); }
    .panel{ min-height: 60vh; }
    #status{ max-width: 70vw; }
  }
</style>
</head>

<body>
  <div id="topbar">
    <div id="leftTop">
      <button class="btn secondary" id="editLinksBtn" type="button">Editar links</button>

      <!-- Tabs -->
      <button class="btn secondary tabBtn active" data-tab="lives" type="button">üé• Lives</button>
      <button class="btn secondary tabBtn" data-tab="mapa" type="button">üó∫ Localiza√ß√£o</button>

      <button class="btn secondary" id="tvBtn" type="button">Modo TV</button>
      <button class="btn secondary" id="soundBtn" type="button">Som: OFF</button>

      <div id="status">Carregando‚Ä¶</div>
    </div>
    <div id="clock">00:00:00</div>
  </div>

  <!-- TAB LIVES -->
  <div id="tab-lives" class="grid">
    <!-- LIVE 1 -->
    <div class="panel" id="panel1">
      <div class="title">
        <div class="name" id="t1">LIVE 1</div>
        <div class="titleRight">
          <div class="liveBadge" id="live1Badge"><span class="dot"></span>AO VIVO</div>
          <div class="pill" id="v1">üëÄ ‚Äî</div>
          <button class="miniBtn" id="toggleChat1" type="button">Ocultar chat</button>
        </div>
      </div>
      <div class="content">
        <iframe id="vid1" allowfullscreen></iframe>
        <iframe id="chat1" class="chat"></iframe>
      </div>
    </div>

    <!-- LIVE 2 -->
    <div class="panel" id="panel2">
      <div class="title">
        <div class="name" id="t2">LIVE 2</div>
        <div class="titleRight">
          <div class="liveBadge" id="live2Badge"><span class="dot"></span>AO VIVO</div>
          <div class="pill" id="v2">üëÄ ‚Äî</div>
          <button class="miniBtn" id="toggleChat2" type="button">Ocultar chat</button>
        </div>
      </div>
      <div class="content">
        <iframe id="vid2" allowfullscreen></iframe>
        <iframe id="chat2" class="chat"></iframe>
      </div>
    </div>
  </div>

  <!-- TAB MAPA -->
  <div id="tab-mapa" class="grid" style="display:none;">
    <div class="panel" style="grid-column:1/-1;">
      <div class="title">
        <div class="name">üó∫ Expedi√ß√£o (Helios)</div>
        <div class="titleRight">
          <div class="pill" id="distTotal">üìè 0,0 km</div>
        </div>
      </div>
      <div id="map" style="width:100%;height:70vh;"></div>
    </div>
  </div>

  <!-- Modal (popup) -->
  <div class="modalOverlay" id="modalOverlay" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <h2 id="modalTitle">Configurar lives</h2>
        <button class="btn secondary" id="closeModalBtn" type="button">Fechar</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label for="liveUrl1">Link da Live 1 (YouTube)</label>
          <input id="liveUrl1" placeholder="https://www.youtube.com/watch?v=..." />
        </div>

        <div class="field">
          <label for="liveUrl2">Link da Live 2 (YouTube)</label>
          <input id="liveUrl2" placeholder="https://www.youtube.com/watch?v=..." />
        </div>

        <div class="hint">
          Dica: cole link de <b>watch?v=</b> ou <b>youtu.be/</b>. Os links ficam salvos neste navegador (localStorage).
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn secondary" id="clearSavedBtn" type="button">Limpar salvos</button>
        <button class="btn" id="saveLinksBtn" type="button">Salvar e carregar</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const YOUTUBE_API_KEY = "AIzaSyBH9rhx0JLh1fwhBSxPsi0L1QoTmZa0OKU";
  const EMBED_DOMAIN = "andremariano07.github.io";
  const REFRESH_EVERY_MS = 15000;
  const LS_KEY = "painelLives.links.v1";

  // Alertas
  const ALERT_ON_GO_LIVE = true;
  const ALERT_VIEWERS_JUMP = 50;
  const ALERT_COOLDOWN_MS = 8000;

  // Helios
  const HELIOS_POS_URL = "https://httpsnome-seu-workerseuusuarioworkersdev.andredeeds.workers.dev/?slug=transamazonica-2026";
  const HELIOS_REFRESH_MS = 10000;
  const HELIOS_MIN_MOVE_KM = 0.01; // 10m

  // =========================
  // REL√ìGIO
  // =========================
  function updateClock(){
    const now = new Date();
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    const s = String(now.getSeconds()).padStart(2,'0');
    document.getElementById('clock').innerText = `${h}:${m}:${s}`;
  }
  setInterval(updateClock, 1000); updateClock();

  // =========================
  // TABS (Lives / Localiza√ß√£o)
  // =========================
  const tabBtns = document.querySelectorAll(".tabBtn");
  const tabLives = document.getElementById("tab-lives");
  const tabMapa  = document.getElementById("tab-mapa");

  function setActiveTab(name){
    tabBtns.forEach(b=>{
      b.classList.toggle("active", b.dataset.tab === name);
    });
    tabLives.style.display = (name === "lives") ? "grid" : "none";
    tabMapa.style.display  = (name === "mapa") ? "grid"  : "none";

    if(name === "mapa"){
      initMapOnce();
      setTimeout(()=>{ if(map) map.invalidateSize(true); }, 120);
    }
  }

  tabBtns.forEach(btn=>{
    btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
  });

  // =========================
  // MODO TV (toggle + fullscreen)
  // =========================
  const tvBtn = document.getElementById("tvBtn");
  function isFullscreen(){ return !!document.fullscreenElement; }

  async function toggleTV(){
    document.body.classList.toggle("tv");
    const on = document.body.classList.contains("tv");
    tvBtn.textContent = on ? "Sair TV" : "Modo TV";

    try{
      if(on && !isFullscreen()){
        await document.documentElement.requestFullscreen();
      }else if(!on && isFullscreen()){
        await document.exitFullscreen();
      }
    }catch(e){}
  }
  tvBtn.addEventListener("click", toggleTV);

  // =========================
  // SOM (WebAudio - precisa clique)
  // =========================
  const soundBtn = document.getElementById("soundBtn");
  let soundEnabled = false;
  let audioCtx = null;
  let lastAlertAt = 0;

  function ensureAudio(){
    if(audioCtx) return;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = new Ctx();
  }

  function beep(freq=880, dur=0.12){
    if(!soundEnabled) return;
    ensureAudio();
    if(audioCtx.state === "suspended") audioCtx.resume();

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;

    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);

    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur + 0.02);
  }

  function alertSound(){
    const now = Date.now();
    if(now - lastAlertAt < ALERT_COOLDOWN_MS) return;
    lastAlertAt = now;
    beep(880, 0.10);
    setTimeout(()=>beep(1175, 0.10), 140);
    setTimeout(()=>beep(880, 0.14), 280);
  }

  soundBtn.addEventListener("click", ()=>{
    soundEnabled = !soundEnabled;
    soundBtn.textContent = soundEnabled ? "Som: ON" : "Som: OFF";
    if(soundEnabled){
      ensureAudio();
      beep(880, 0.08);
    }
  });

  // =========================
  // UTIL: extrair ID do YouTube
  // =========================
  function extractYouTubeId(input){
    if(!input) return null;
    const s = input.trim();

    if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;

    try{
      const u = new URL(s);
      const v = u.searchParams.get("v");
      if(v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;

      if(u.hostname.includes("youtu.be")){
        const id = u.pathname.replace("/","").split("/")[0];
        if(/^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
      }

      const parts = u.pathname.split("/").filter(Boolean);
      if(parts.length >= 2 && ["live","embed","shorts"].includes(parts[0])){
        const id = parts[1];
        if(/^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
      }
    }catch(e){}
    return null;
  }

  // =========================
  // MODAL
  // =========================
  const modalOverlay = document.getElementById("modalOverlay");
  const liveUrl1Input = document.getElementById("liveUrl1");
  const liveUrl2Input = document.getElementById("liveUrl2");

  function saveLinks(url1, url2){
    localStorage.setItem(LS_KEY, JSON.stringify({ url1, url2 }));
  }
  function loadSavedLinks(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){
      return null;
    }
  }
  function clearSavedLinks(){ localStorage.removeItem(LS_KEY); }

  function openModal(){
    const saved = loadSavedLinks();
    if(saved){
      liveUrl1Input.value = saved.url1 || "";
      liveUrl2Input.value = saved.url2 || "";
    }
    modalOverlay.style.display = "flex";
    setTimeout(()=> liveUrl1Input.focus(), 50);
  }
  function closeModal(){ modalOverlay.style.display = "none"; }

  document.getElementById("editLinksBtn").addEventListener("click", openModal);
  document.getElementById("closeModalBtn").addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e)=>{ if(e.target === modalOverlay) closeModal(); });

  document.getElementById("clearSavedBtn").addEventListener("click", ()=>{
    clearSavedLinks();
    liveUrl1Input.value = "";
    liveUrl2Input.value = "";
  });

  // =========================
  // CHAT TOGGLE (um por live)
  // =========================
  function setChatHidden(panelEl, btnEl, hidden){
    panelEl.classList.toggle("chat-hidden", hidden);
    btnEl.textContent = hidden ? "Mostrar chat" : "Ocultar chat";
    btnEl.setAttribute("aria-pressed", hidden ? "true" : "false");
  }

  const panel1 = document.getElementById("panel1");
  const panel2 = document.getElementById("panel2");
  const toggleChat1 = document.getElementById("toggleChat1");
  const toggleChat2 = document.getElementById("toggleChat2");

  setChatHidden(panel1, toggleChat1, false);
  setChatHidden(panel2, toggleChat2, false);

  toggleChat1.addEventListener("click", ()=> setChatHidden(panel1, toggleChat1, !panel1.classList.contains("chat-hidden")));
  toggleChat2.addEventListener("click", ()=> setChatHidden(panel2, toggleChat2, !panel2.classList.contains("chat-hidden")));

  // =========================
  // IFRAMES / IDs din√¢micos
  // =========================
  let VIDEO_1 = "N0lqE1yAduE";
  let VIDEO_2 = "w2wQeZ1L1Mo";

  function setVideoIds(id1, id2){
    VIDEO_1 = id1;
    VIDEO_2 = id2;

    document.getElementById("vid1").src = `https://www.youtube.com/embed/${VIDEO_1}`;
    document.getElementById("vid2").src = `https://www.youtube.com/embed/${VIDEO_2}`;

    document.getElementById("chat1").src = `https://www.youtube.com/live_chat?v=${VIDEO_1}&embed_domain=${EMBED_DOMAIN}`;
    document.getElementById("chat2").src = `https://www.youtube.com/live_chat?v=${VIDEO_2}&embed_domain=${EMBED_DOMAIN}`;
  }

  document.getElementById("saveLinksBtn").addEventListener("click", ()=>{
    const url1 = liveUrl1Input.value.trim();
    const url2 = liveUrl2Input.value.trim();

    const id1 = extractYouTubeId(url1);
    const id2 = extractYouTubeId(url2);

    if(!id1 || !id2){
      alert("Cole links v√°lidos do YouTube para as duas lives (ou o ID do v√≠deo com 11 caracteres).");
      return;
    }

    saveLinks(url1, url2);
    setVideoIds(id1, id2);
    closeModal();
    refreshAll();
  });

  // =========================
  // T√çTULO AUTOM√ÅTICO (oEmbed)
  // =========================
  async function fetchTitle(videoId){
    const url = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Falha ao buscar t√≠tulo (oEmbed).");
    const data = await res.json();
    return data.title || "Sem t√≠tulo";
  }

  // =========================
  // VIEWERS + LIVE STATUS (YouTube Data API)
  // =========================
  async function fetchLiveInfo(videoId){
    if(!YOUTUBE_API_KEY || YOUTUBE_API_KEY.trim() === "") return null;

    const url =
      `https://www.googleapis.com/youtube/v3/videos` +
      `?part=liveStreamingDetails&id=${videoId}&key=${encodeURIComponent(YOUTUBE_API_KEY)}`;

    const res = await fetch(url);
    if(!res.ok){
      let detail = "";
      try{
        const err = await res.json();
        detail = err?.error?.message ? ` | ${err.error.message}` : "";
      }catch(e){}
      throw new Error(`API HTTP ${res.status}${detail}`);
    }

    const data = await res.json();
    const item = data.items && data.items[0];
    const d = item?.liveStreamingDetails;

    const concurrent = d?.concurrentViewers ? Number(d.concurrentViewers) : 0;
    const started = !!d?.actualStartTime;
    const ended = !!d?.actualEndTime;
    const isLive = started && !ended;

    return { viewers: concurrent, isLive };
  }

  function formatViewers(n){
    if (n === null) return "üëÄ ‚Äî";
    return `üëÄ ${Number(n).toLocaleString("pt-BR")}`;
  }

  function setLiveBadge(which, isLive){
    const el = document.getElementById(which === 1 ? "live1Badge" : "live2Badge");
    el.style.display = isLive ? "inline-flex" : "none";
  }

  // estados anteriores pra alerta
  let prev = { live1:false, live2:false, v1:0, v2:0 };

  async function refreshAll(){
    const status = document.getElementById("status");
    try{
      status.innerText = "Atualizando‚Ä¶";

      const [title1, title2] = await Promise.all([ fetchTitle(VIDEO_1), fetchTitle(VIDEO_2) ]);
      document.getElementById("t1").innerText = title1;
      document.getElementById("t2").innerText = title2;

      const [info1, info2] = await Promise.all([ fetchLiveInfo(VIDEO_1), fetchLiveInfo(VIDEO_2) ]);

      if(info1 === null || info2 === null){
        document.getElementById("v1").innerText = "üëÄ ‚Äî";
        document.getElementById("v2").innerText = "üëÄ ‚Äî";
        setLiveBadge(1, false);
        setLiveBadge(2, false);
        status.innerText = "T√≠tulos OK. Cole a API key para viewers / ao vivo.";
        return;
      }

      document.getElementById("v1").innerText = formatViewers(info1.viewers);
      document.getElementById("v2").innerText = formatViewers(info2.viewers);
      setLiveBadge(1, info1.isLive);
      setLiveBadge(2, info2.isLive);

      if(soundEnabled){
        if(ALERT_ON_GO_LIVE){
          if(!prev.live1 && info1.isLive) alertSound();
          if(!prev.live2 && info2.isLive) alertSound();
        }
        if(ALERT_VIEWERS_JUMP > 0){
          if((info1.viewers - prev.v1) >= ALERT_VIEWERS_JUMP) alertSound();
          if((info2.viewers - prev.v2) >= ALERT_VIEWERS_JUMP) alertSound();
        }
      }

      prev.live1 = info1.isLive;
      prev.live2 = info2.isLive;
      prev.v1 = info1.viewers;
      prev.v2 = info2.viewers;

      status.innerText = "Atualizado ‚úÖ";
    }catch(e){
      status.innerText = `Erro: ${e.message}`;
    }
  }

  // =========================
  // MAPA HELIOS (com status + zoom seguro + labels)
  // =========================
  let map = null;
  let mapInited = false;
  let heliosTimer = null;

  const blinkIcon = L.divIcon({
    className: "",
    html: `<div class="blinkDot"></div>`,
    iconSize: [18,18],
    iconAnchor: [9,9]
  });

  // ‚úÖ 1) Estados adicionados (markers + paths + polylines + cores)
  const userMarkers = {};     // userId -> marker
  const userPaths = {};       // userId -> array de [lat,lng]
  const userPolylines = {};   // userId -> polyline (trajeto)
  const pathColors = ["#00bfff","#00ff88","#ffcc00","#ff4d4d","#b084ff","#ff7ad9","#66ccff","#ffa866"];
  let totalKm = 0;

  function haversineKm(a, b){
    const R = 6371;
    const toRad = x => x * Math.PI/180;
    const dLat = toRad(b[0] - a[0]);
    const dLon = toRad(b[1] - a[1]);
    const lat1 = toRad(a[0]);
    const lat2 = toRad(b[0]);
    const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(s));
  }

  function setDistUI(){
    document.getElementById("distTotal").innerText =
      `üìè ${totalKm.toLocaleString("pt-BR", { maximumFractionDigits: 1 })} km`;
  }

  function initMapOnce(){
    if(mapInited) return;
    mapInited = true;

    map = L.map("map").setView([-7.9, -61.5], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    // ‚úÖ pedido: logo ap√≥s criar o map
    setTimeout(()=> map.invalidateSize(true), 150);

    // inicia loop
    refreshHelios();
    heliosTimer = setInterval(refreshHelios, HELIOS_REFRESH_MS);
  }

  function formatSpeedKmh(speed){
    // no Helios parece m/s -> km/h
    const kmh = (Number(speed || 0) * 3.6);
    return `${kmh.toLocaleString("pt-BR", { maximumFractionDigits: 1 })} km/h`;
  }

  async function refreshHelios(){
    const status = document.getElementById("status");
    try{
      const res = await fetch(HELIOS_POS_URL, { cache:"no-store" });

      if(!res.ok){
        status.innerText = `Helios: HTTP ${res.status}`;
        return;
      }

      const data = await res.json();

      if(!data.positions || !data.positions.length){
        status.innerText = "Helios: sem posi√ß√µes no momento";
        return;
      }

      // centraliza/ajusta zoom no primeiro retorno (se ainda estiver muito longe)
      const first = data.positions[0];
      if(first && map){
        const z = map.getZoom();
        if(z < 8){
          map.setView([first.latitude, first.longitude], 10, { animate: true });
        }
      }

      data.positions.forEach(p=>{
        const pos = [p.latitude, p.longitude];
        const speedTxt = formatSpeedKmh(p.speed);

        const labelHtml = `
          <div>
            üë§ ${p.userName}<br>
            üöó ${speedTxt}
          </div>
        `;

        // ‚úÖ 2) Substitui√ß√£o: cria polyline quando o usu√°rio aparece + atualiza quando move
        if(!userMarkers[p.userId]){
          userMarkers[p.userId] = L.marker(pos, { icon: blinkIcon }).addTo(map)
            .bindTooltip(labelHtml, {
              permanent: true,
              direction: "top",
              offset: [0, -15],
              className: "permaLabel"
            });

          userPaths[p.userId] = [pos];

          // ‚úÖ cria a linha do trajeto (come√ßa com 1 ponto)
          const color = pathColors[Object.keys(userPolylines).length % pathColors.length];
          userPolylines[p.userId] = L.polyline(userPaths[p.userId], {
            weight: 4,
            opacity: 0.9,
            color
          }).addTo(map);

        } else {
          userMarkers[p.userId].setLatLng(pos);
          const tt = userMarkers[p.userId].getTooltip();
          if(tt) tt.setContent(labelHtml);

          const path = userPaths[p.userId] || [];
          const last = path[path.length - 1];
          const movedKm = last ? haversineKm(last, pos) : 0;

          if(!last || movedKm > HELIOS_MIN_MOVE_KM){
            path.push(pos);
            userPaths[p.userId] = path;

            // ‚úÖ atualiza a linha do trajeto
            const line = userPolylines[p.userId];
            if(line) line.setLatLngs(path);

            totalKm += movedKm;
            setDistUI();
          }
        }
      });

      // ‚úÖ 3) (Opcional) Centralizar o mapa para mostrar TODO o trajeto
      // (deixe comentado pra n√£o ficar "pulando")
      /*
      const allLines = Object.values(userPolylines);
      if(allLines.length){
        const group = L.featureGroup(allLines);
        map.fitBounds(group.getBounds().pad(0.2));
      }
      */

      status.innerText = "Helios OK ‚úÖ";
    } catch(e){
      // Aqui vai aparecer se for CORS
      status.innerText = `Helios erro: ${e.message}`;
      console.error("Helios fetch erro:", e);
    }
  }

  // =========================
  // INIT
  // =========================
  const saved = loadSavedLinks();
  if(saved && saved.url1 && saved.url2){
    const id1 = extractYouTubeId(saved.url1);
    const id2 = extractYouTubeId(saved.url2);
    if(id1 && id2){
      setVideoIds(id1, id2);
      refreshAll();
      setInterval(refreshAll, REFRESH_EVERY_MS);
    }else{
      openModal();
    }
  }else{
    openModal();
  }

</script>
</body>
</html>
